<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>이름을 호명하시오</title>
<style>
@font-face{
  font-family:"OnulDanjo";
  src:url("./OnulDanjo-Regular.otf") format("opentype");
  font-display:swap;
}
@font-face{
  font-family:"WingdingsCustom";
  src:url("./Wingdings.ttf") format("truetype");
  font-display:swap;
}

html,body{
  height:100%; margin:0; background:#000; overflow:hidden;
  font-family:"OnulDanjo", Arial, sans-serif; color:#000;
}

/* ==== 배경 ==== */
.bg-rings{
  position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
  z-index:0; pointer-events:none;
}
.bg-rings svg{ width:100vmin; height:100vmin; overflow:visible; }
.ring{ transform-box:fill-box; transform-origin:50% 50%; }
@keyframes spinZoom-cw{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.5)}100%{transform:rotate(360deg) scale(1)}}
@keyframes spinZoom-ccw{0%{transform:rotate(0) scale(1)}50%{transform:rotate(-180deg) scale(1.5)}100%{transform:rotate(-360deg) scale(1)}}
.r1{animation:spinZoom-cw 12s ease-in-out infinite;}
.r2{animation:spinZoom-ccw 10s ease-in-out infinite;}
.r3{animation:spinZoom-cw 8s ease-in-out infinite;}
.r4{animation:spinZoom-ccw 6s ease-in-out infinite;}

/* ==== 시트 ==== */
.sheet-wrap{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  z-index:2; overflow:auto; max-height:85vh; border:1px solid #000; background:transparent;
}
.sheet-wrap::-webkit-scrollbar{width:6px;height:6px}
.sheet-wrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:4px;}
.sheet-wrap::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.5)}
.sheet-wrap::-webkit-scrollbar-track{background:transparent}

table.sheet{
  border-collapse:collapse; border:1px solid #000; table-layout:fixed; font-size:13px;
  font-family:"OnulDanjo","Noto Sans KR",sans-serif; color:#000;
}
.sheet th,.sheet td{
  border:1px solid #000; height:28px; text-align:center; vertical-align:middle;
  transition:background .25s ease; font-weight:400;
}
.sheet th:first-child,.sheet td:first-child{
  width:140px; text-align:left; padding-left:8px; font-weight:500;
}
.sheet th:not(:first-child),.sheet td:not(:first-child){ width:38px; }

/* ==== 자음/모음 ==== */
.icon{
  display:inline-flex; justify-content:center; align-items:center;
  width:22px; height:22px; border:1.4px dotted #000; border-radius:50%;
  font-family:"WingdingsCustom"; font-size:18px; opacity:0; transform:scale(.5);
  transition:all .4s ease;
}
.icon.show{opacity:1; transform:scale(1);}
.vowel{
  display:inline-block; background:#000; border-radius:50%;
  width:12px; height:12px; opacity:0; transition:opacity .25s ease;
}
.vowel.show{opacity:1;}

/* ==== 컨트롤 ==== */
.print-bar{position:fixed; left:12px; bottom:12px; z-index:3; display:flex; gap:8px;}
.btn{cursor:pointer; background:#fff; color:#000; border-radius:8px; padding:6px 10px; border:none; font-size:12px;}
.hint{position:fixed; left:12px; bottom:48px; font-size:12px; color:#ccc; z-index:3}

/* ==== 설명 버튼 ==== */
.info-btn{
  position:fixed; right:16px; bottom:16px; z-index:5;
  background:#fff; color:#000; border:none; border-radius:20px; padding:6px 12px; font-size:13px;
  cursor:pointer; opacity:.8; transition:opacity .2s ease;
}
.info-btn:hover{opacity:1}
.info-modal{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; justify-content:center; align-items:center; z-index:10;
}
.info-content{
  position:relative; background:#fff; color:#111;
  max-width:260px; padding:24px 28px; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.25);
  font-family:"OnulDanjo","Noto Sans KR",sans-serif; line-height:1.6; animation:fadeIn .4s ease;
}
.info-content p{font-size:13.5px; margin:0 0 6px 0;}
.info-content .close{position:absolute; right:22px; top:18px; font-size:20px; cursor:pointer; color:#333}
@keyframes fadeIn{from{opacity:0; transform:translateY(10px)}to{opacity:1; transform:none}}

@media print{
  @page{ size:A4 portrait; margin:10mm }
  *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
  .bg-rings,.print-bar,.hint,.info-btn,.info-modal{ display:none !important }
  html,body{ background:#fff !important; color:#000 !important; overflow:visible !important; height:auto }
}
</style>
</head>
<body>

<!-- ==== 배경 ==== -->
<div class="bg-rings">
  <svg viewBox="0 0 1000 1000">
    <circle class="ring r1" cx="500" cy="500" r="500" fill="none" stroke="#fff" stroke-width="260"/>
    <circle class="ring r2" cx="500" cy="500" r="370" fill="none" stroke="#e6e6e6" stroke-width="240"/>
    <circle class="ring r3" cx="500" cy="500" r="250" fill="none" stroke="#999" stroke-width="220"/>
    <circle class="ring r4" cx="500" cy="500" r="130" fill="none" stroke="#444" stroke-width="200"/>
    <circle cx="500" cy="500" r="70" fill="#000"/>
  </svg>
</div>

<!-- ==== 시트 ==== -->
<div class="sheet-wrap" id="sheetWrap">
  <table class="sheet" id="sheet">
    <thead><tr><th>NAME</th></tr></thead>
    <tbody id="sheetBody"></tbody>
  </table>
</div>

<div class="hint" id="hint">🎧 활성화</div>
<div class="print-bar">
  <button id="startBtn" class="btn">🎙</button>
  <button id="printBtn" class="btn">📄PDF</button>
</div>

<!-- ==== 설명 버튼 & 팝업 ==== -->
<button id="infoBtn" class="info-btn">ℹ︎ 설명</button>
<div id="infoModal" class="info-modal">
  <div class="info-content">
    <span class="close">&times;</span>
    <p>이름들의 생김새는 완벽히 동등한 것이 없는데 어딘가 가만히 바라보고 있으면 모두 하나로 느껴진다.</p>
    <p>⑴ 이름은 서로 상생되어야 한다.<br>⑵ 이름의 첫·중·끝 글자는 연결돼 있다.<br>⑶ 소리는 주변에 영향을 준다.</p>
    <p>소리 내어 공기를 진동시켜야만 효과가 나타난다. 이름이 단순한 표식이 아니라, 발화되는 순간에 생명력을 얻는 언어적 존재임을 시사한다.</p>
    <p>호명을 통해 호출된 이름들은 시트 위에 기록되고, 그 소리와 리듬은 울림이 된다.</p>
    <p>이름을 호명하시오.</p>
  </div>
</div>

<script>
/* ==== 설명 팝업 ==== */
const infoBtn=document.getElementById('infoBtn');
const infoModal=document.getElementById('infoModal');
const close=document.querySelector('.info-content .close');
infoBtn.onclick=()=>infoModal.style.display='flex';
close.onclick=()=>infoModal.style.display='none';
infoModal.onclick=e=>{ if(e.target===infoModal) infoModal.style.display='none'; };

/* ==== 시트 설정 ==== */
const MAX_NAME_LEN=6, MAX_PARTS_PER_SYLL=3, MAX_COLS=MAX_NAME_LEN*MAX_PARTS_PER_SYLL;
const MAP={"ㄱ":"1","ㄴ":"2","ㄷ":"9","ㄹ":"0","ㅁ":"9","ㅂ":"0","ㅅ":"7","ㅇ":"8","ㅈ":"5","ㅊ":"6","ㅋ":"4","ㅌ":"3","ㅍ":"5","ㅎ":"6"};
const RING_COLORS=["#f5f5f5","#cccccc","#888888","#000000"];
const sheet=document.getElementById('sheet');
const sheetBody=document.getElementById('sheetBody');
const hint=document.getElementById('hint');

function initSheetColumns(n){
  const header=sheet.querySelector('thead tr');
  for(let i=1;i<=n;i++){ const th=document.createElement('th'); th.textContent=i; header.appendChild(th); }
}
initSheetColumns(MAX_COLS);

/* ==== 한글 분해 ==== */
function decomposeHangul(ch){
  const base=0xAC00;
  const chos="ㄱㄲㄴㄷㄸㄹㅁㅂㅃㅅㅆㅇㅈㅉㅊㅋㅌㅍㅎ";
  const jungs="ㅏㅐㅑㅒㅓㅔㅕㅖㅗㅘㅙㅚㅛㅜㅝㅞㅟㅠㅡㅢㅣ";
  const jongs=["","ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
  const code=ch.charCodeAt(0)-base;
  if(code<0||code>11171) return [ch];
  const cho=Math.floor(code/588), jung=Math.floor((code%588)/28), jong=code%28;
  const arr=[chos[cho], jungs[jung]]; if(jongs[jong]) arr.push(jongs[jong]); return arr;
}
function createVowelShape(){ const div=document.createElement('div'); div.className='vowel'; return div; }

/* ==== 행 추가 ==== */
async function addRow(name){
  const chars=[...name]; const parts=[]; chars.forEach(ch=>parts.push(...decomposeHangul(ch)));
  const tr=document.createElement('tr'); const tdName=document.createElement('td'); tdName.textContent=name; tr.appendChild(tdName);
  for(let i=0;i<MAX_COLS;i++) tr.appendChild(document.createElement('td')); sheetBody.appendChild(tr);

  tdName.addEventListener('mouseenter',()=>{const c=RING_COLORS[Math.floor(Math.random()*RING_COLORS.length)];
    tdName.style.background=c; tdName.style.color=(c==="#000000"?"#fff":"#000");});
  tdName.addEventListener('mouseleave',()=>{tdName.style.background="transparent"; tdName.style.color="#000";});
  tdName.addEventListener('click',()=>waveRow(tr,80,true));

  const tds=[...tr.querySelectorAll('td')].slice(1);
  for(let i=0;i<parts.length && i<tds.length;i++){
    const td=tds[i];
    setTimeout(()=>{
      const c=RING_COLORS[Math.floor(Math.random()*RING_COLORS.length)];
      td.style.background=c;
      if(MAP[parts[i]]){const d=document.createElement('div'); d.className='icon'; d.textContent=MAP[parts[i]]; td.appendChild(d); setTimeout(()=>d.classList.add('show'),50);}
      else if(/[ㅏ-ㅣ]/.test(parts[i])){const v=createVowelShape(); td.appendChild(v); setTimeout(()=>v.classList.add('show'),50);}
      setTimeout(()=>td.style.background='transparent',600);
    }, i*180);
  }
  tr.scrollIntoView({behavior:'smooth',block:'end'});
}

/* ==== 파도 ==== */
function waveRow(tr,step=100){const cells=[...tr.querySelectorAll('td')].slice(1);
  const color=RING_COLORS[Math.floor(Math.random()*RING_COLORS.length)];
  for(let i=0;i<cells.length;i++){setTimeout(()=>{cells[i].style.background=color;setTimeout(()=>cells[i].style.background='transparent',200);},i*step);}}

/* ==== 음성 + 마이크 ==== */
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
let recog,audioCtx,analyser,timeData,micStream; let noiseFloor=0.02,lastTrigger=0;
function rms(buf){let s=0;for(let i=0;i<buf.length;i++){const v=(buf[i]-128)/128;s+=v*v;}return Math.sqrt(s/buf.length);}
async function setupMic(){micStream=await navigator.mediaDevices.getUserMedia({audio:true});
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();const src=audioCtx.createMediaStreamSource(micStream);
  analyser=new AnalyserNode(audioCtx,{fftSize:1024,smoothingTimeConstant:.85});src.connect(analyser);timeData=new Uint8Array(analyser.fftSize);
  const samples=[],st=performance.now();hint.style.display='block';hint.textContent='🎧 캘리브레이션 중...';
  (function c(){analyser.getByteTimeDomainData(timeData);samples.push(rms(timeData));
    if(performance.now()-st<1500)requestAnimationFrame(c);else{samples.sort((a,b)=>a-b);const mid=samples[Math.floor(samples.length*.5)]||0.02;
      noiseFloor=Math.max(.015,Math.min(.08,mid));hint.textContent='✅ 음성 반응 활성화됨';setTimeout(()=>hint.style.display='none',1200);animateSound();}})();}
function animateSound(){analyser.getByteTimeDomainData(timeData);const r=rms(timeData),now=performance.now(),th=noiseFloor+.035;
  if(r>th&&now-lastTrigger>140){lastTrigger=now;waveRow(document.querySelector('tr:last-child')||sheetBody,80);}
  requestAnimationFrame(animateSound);}
function startSR(){if(!SR)return;recog=new SR();recog.lang='ko-KR';recog.continuous=true;recog.interimResults=true;
  recog.onresult=e=>{for(let i=e.resultIndex;i<e.results.length;i++){const res=e.results[i];if(!res.isFinal)continue;
    const raw=res[0].transcript.trim(),txt=raw.replace(/\s+/g,''),rx=/([가-힣]{1,6})(?:이|가|를|을|은|는)?(아|야)/g;let m;while((m=rx.exec(txt))!==null){addRow(m[1]);}}};
  recog.onend=()=>{try{recog.start();}catch(_){}};recog.start();}

/* ==== 버튼 ==== */
document.getElementById('startBtn').addEventListener('click',async()=>{try{await setupMic();startSR();}catch(e){alert('마이크 권한이 필요합니다.');}});
document.getElementById('printBtn').addEventListener('click',()=>window.print());
</script>
</body>
</html>
